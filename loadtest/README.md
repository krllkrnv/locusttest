# Нагрузочное тестирование REST и gRPC сервисов глоссария

Инструкции по проведению нагрузочного тестирования с помощью Locust.

**Важно**: параметры нагрузки (количество пользователей, spawn rate, длительность) подбираются **экспериментально**. Ниже приведена рабочая схема запуска и итеративного подбора с фиксацией артефактов (CSV/HTML).

## Подготовка окружения

### 1. Установка зависимостей

```bash
cd loadtest
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

### 2. Генерация protobuf файлов

```bash
# Убедитесь, что venv активирован
source venv/bin/activate

# Генерация protobuf файлов для gRPC клиента
python -m grpc_tools.protoc \
  -I ../grpc-test-vkr-main/vkr-glossary-grpc-project/glossary-grpc/glossary-service/protobufs \
  --python_out=grpc_gen \
  --grpc_python_out=grpc_gen \
  ../grpc-test-vkr-main/vkr-glossary-grpc-project/glossary-grpc/glossary-service/protobufs/glossary.proto
```

## Запуск сервисов

Перед запуском тестов необходимо запустить оба сервиса.

### Быстрый запуск (рекомендуется)

Используйте готовые скрипты из директории `scripts/`:

**Терминал 1 - REST сервис:**
```bash
cd ..
./scripts/start_rest.sh
```

**Терминал 2 - gRPC сервис:**
```bash
cd ..
./scripts/start_grpc.sh
```

**Проверка доступности:**
```bash
cd ..
./scripts/check_services.sh
```

### Ручной запуск

#### REST сервис (порт 8000)

```bash
cd ../mindmap-vkr-main/backend
source venv/bin/activate
uvicorn app.main:app --host 0.0.0.0 --port 8000
```

#### gRPC сервис (порт 50052)

```bash
cd ../grpc-test-vkr-main/vkr-glossary-grpc-project/glossary-grpc/glossary-service
source venv/bin/activate
python glossary.py
```

## Методика подбора параметров нагрузки

Параметры подбираются итеративно: старт с минимальных значений → увеличение нагрузки → фиксация метрик и артефактов → выбор “рабочей” нагрузки для сравнения.

### Общий подход

1. **Начать с минимальных значений** и постепенно увеличивать нагрузку
2. **Фиксировать метрики** на каждом этапе (RPS, латентность, ошибки)
3. **Анализировать результаты** и определять оптимальные значения
4. **Задокументировать процесс** подбора в отчете

### Сценарий 1: Легкая нагрузка (Sanity Check)

**Цель**: Убедиться, что всё работает

**Методика**: Использовать минимальные значения для быстрой проверки

**Стартовые параметры** (можно изменить):
- Пользователи: 5
- Spawn rate: 1 пользователь/сек
- Длительность: 2 минуты

**Команды**:

#### Используя скрипт (рекомендуется):
```bash
cd ..
./scripts/run_test.sh rest sanity 5 1 2m
./scripts/run_test.sh grpc sanity 5 1 2m
```

#### Или вручную:
```bash
cd loadtest
source venv/bin/activate
locust -f locustfile_rest.py --host http://127.0.0.1:8000 -u 5 -r 1 -t 2m --csv out/rest_sanity --html out/rest_sanity.html --headless

GRPC_TARGET=127.0.0.1:50052 locust -f locustfile_grpc.py -u 5 -r 1 -t 2m --csv out/grpc_sanity --html out/grpc_sanity.html --headless
```

**Ожидаемый результат**: 0 ошибок, стабильная латентность

### Сценарий 2: Рабочая нагрузка (Normal Load)

**Цель**: Подобрать параметры, имитирующие реалистичное использование

**Методика итеративного подбора**:

1. **Итерация 1**: Начать с 10 пользователей, spawn rate 2/сек, длительность 2-3 минуты
   ```bash
   # Используя скрипт
   cd ..
   ./scripts/run_test.sh rest normal 10 2 3m
   ./scripts/run_test.sh grpc normal 10 2 3m
   
   # Или вручную
   cd loadtest
   source venv/bin/activate
   locust -f locustfile_rest.py --host http://127.0.0.1:8000 -u 10 -r 2 -t 3m --csv out/rest_normal_iter1 --html out/rest_normal_iter1.html --headless
   GRPC_TARGET=127.0.0.1:50052 locust -f locustfile_grpc.py -u 10 -r 2 -t 3m --csv out/grpc_normal_iter1 --html out/grpc_normal_iter1.html --headless
   ```
   **Зафиксировать**: RPS, средняя латентность, ошибки

2. **Итерация 2**: Увеличить до 25 пользователей, spawn rate 5/сек
   ```bash
   ./scripts/run_test.sh rest normal 25 5 3m
   ./scripts/run_test.sh grpc normal 25 5 3m
   ```
   **Зафиксировать**: Изменение метрик

3. **Итерация 3**: Увеличить до 50 пользователей, spawn rate 5/сек
   ```bash
   ./scripts/run_test.sh rest normal 50 5 3m
   ./scripts/run_test.sh grpc normal 50 5 3m
   ```
   **Зафиксировать**: Изменение метрик

4. **Продолжать увеличивать** до тех пор, пока:
   - Латентность остается приемлемой (< 200-500ms)
   - Количество ошибок минимально (< 1%)
   - RPS стабилен

5. **Выбрать оптимальные параметры** для рабочей нагрузки и провести финальный тест с длительностью 5 минут

**В отчете указать**:
- Какие итерации были проведены
- Метрики каждой итерации
- Обоснование выбранных параметров рабочей нагрузки

### Сценарий 3: Стресс-тест (Stress Test)

**Цель**: Выявить пределы производительности, найти момент наступления деградации

**Методика итеративного подбора**:

1. **Начать с параметров рабочей нагрузки** (найденных в сценарии 2)

2. **Постепенно увеличивать нагрузку**:
   - Итерация 1: +25% пользователей
   - Итерация 2: +50% пользователей
   - Итерация 3: +100% пользователей
   - И т.д.

3. **На каждом этапе фиксировать**:
   - RPS
   - Среднюю латентность
   - p95/p99 латентность
   - Количество ошибок
   - **Момент начала деградации** (когда латентность начинает расти, появляются ошибки)

4. **Определить точку деградации**:
   - При каком количестве пользователей начинается рост латентности
   - При каком количестве появляются ошибки
   - Максимальный RPS до деградации

**Пример команд** (параметры подбираются экспериментально):
```bash
# Итерация 1: 75 пользователей (если рабочая нагрузка была 50)
./scripts/run_test.sh rest stress 75 10 3m
./scripts/run_test.sh grpc stress 75 10 3m

# Итерация 2: 100 пользователей
./scripts/run_test.sh rest stress 100 10 3m
./scripts/run_test.sh grpc stress 100 10 3m

# Итерация 3: 150 пользователей
./scripts/run_test.sh rest stress 150 15 3m
./scripts/run_test.sh grpc stress 150 15 3m
```

**В отчете указать**:
- График зависимости латентности от количества пользователей
- Точное количество пользователей, при котором начинается деградация
- Максимальный RPS до деградации

### Сценарий 4: Тест на стабильность (Stability Test)

**Цель**: Проверить деградацию при длительной нагрузке

**Методика**: Использовать параметры рабочей нагрузки (найденные в сценарии 2), но запустить на длительное время

**Параметры**:
- Количество пользователей: из сценария 2 (рабочая нагрузка)
- Spawn rate: из сценария 2
- Длительность: 10-15 минут (достаточно для проверки стабильности)

**Команды** (пример с параметрами из рабочей нагрузки):
```bash
# Используя скрипт (пример: если рабочая нагрузка была 50 пользователей)
./scripts/run_test.sh rest stability 50 5 15m
./scripts/run_test.sh grpc stability 50 5 15m

# Или вручную
cd loadtest
source venv/bin/activate
locust -f locustfile_rest.py --host http://127.0.0.1:8000 -u 50 -r 5 -t 15m --csv out/rest_stability --html out/rest_stability.html --headless
GRPC_TARGET=127.0.0.1:50052 locust -f locustfile_grpc.py -u 50 -r 5 -t 15m --csv out/grpc_stability --html out/grpc_stability.html --headless
```

**Мониторинг**:
- Отслеживать изменение метрик во времени
- Проверить наличие утечек памяти
- Зафиксировать деградацию производительности (если есть)

**В отчете указать**:
- Изменение метрик во времени
- Наличие/отсутствие утечек памяти
- Выводы о стабильности системы

## Параметры команд Locust

- `-f` - файл с тестами
- `--host` - базовый URL сервера (только для REST)
- `-u` - количество пользователей (подбирается экспериментально)
- `-r` - spawn rate (пользователей в секунду) (подбирается экспериментально)
- `-t` - длительность теста (например, `2m`, `3m`, `5m`, `15m`)
- `--csv` - префикс для CSV файлов с результатами
- `--html` - путь к HTML отчету
- `--headless` - запуск без веб-интерфейса

## Важные замечания

1. **Параметры нагрузки подбираются экспериментально** - не используйте готовые значения без проверки
2. **Фиксируйте результаты каждой итерации** - это поможет найти оптимальные параметры
3. **Сравнивайте REST и gRPC при одинаковых параметрах** - для корректного сравнения
4. **Документируйте процесс подбора** - опишите в отчете, как подбирались параметры и почему были выбраны конкретные значения

## Результаты тестов

Результаты сохраняются в директории `out/`:

- CSV файлы с метриками: `*_stats.csv`, `*_failures.csv`, `*_exceptions.csv`
- HTML отчеты: `*.html` (можно открыть в браузере)

## Использование скриптов

Для удобства созданы скрипты в директории `scripts/`:

- `start_rest.sh` - запуск REST сервиса
- `start_grpc.sh` - запуск gRPC сервиса
- `check_services.sh` - проверка доступности сервисов
- `run_test.sh` - запуск одного теста
- `run_all_tests.sh` - запуск всех тестов

Подробнее: `scripts/README.md`

## Интерактивный режим

Для интерактивного запуска (с веб-интерфейсом) уберите флаг `--headless`:

```bash
cd loadtest
source venv/bin/activate

# REST
locust -f locustfile_rest.py --host http://127.0.0.1:8000

# gRPC
GRPC_TARGET=127.0.0.1:50052 locust -f locustfile_grpc.py
```

Затем откройте в браузере: `http://localhost:8089`

